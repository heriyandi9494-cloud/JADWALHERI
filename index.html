<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Aktivitas (Fixed)</title>
<style>
  body{font-family:Arial;margin:0;padding:12px;background:#f4f4f4}
  h2{ text-align:center; margin-bottom:12px; }
  table{width:100%;border-collapse:collapse;margin-bottom:10px;background:#fff}
  th,td{padding:6px;border:1px solid #ccc;text-align:center;font-size:14px}
  th{background:#007bff;color:#fff}
  input,select{width:100%;box-sizing:border-box;padding:6px}
  button{padding:8px 12px;margin:6px;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer}
  .progress-container{width:100%;background:#e9ecef;border-radius:12px;overflow:hidden}
  .progress-bar{height:24px;line-height:24px;color:#fff;padding:0 8px;text-align:left}
  .progress-work{background:#dc3545}
  .progress-other{background:#ffc107;color:#000}
  .progress-sleep{background:#28a745}
  .progress-activity{background:#007bff}
  @media (max-width:600px){ th,td{font-size:12px;padding:4px} button{padding:6px} }
</style>
</head>
<body>

<h2 id="pageTitle">ğ‰ğ€ğƒğ–ğ€ğ‹ ğ€ğŠğ“ğˆğ•ğˆğ“ğ€ğ’ ğ‡ğ„ğ‘ğˆ ğ’ğ„ğ‡ğ€ğ‘-ğ‡ğ€ğ‘ğˆ</h2>

<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
  <button onclick="addRow()">Tambah Aktivitas</button>
  <button onclick="saveToFirebase()">Simpan ke Firebase</button>
  <button onclick="showSummary()">Lihat Rangkuman</button>
  <button onclick="console.log(allData)">Debug allData</button>
</div>

<label>Filter Tanggal: <input type="date" id="filterDate" onchange="filterByDate()"></label>

<table id="activityTable">
  <thead>
    <tr>
      <th>No</th><th>Hari</th><th>Tanggal</th><th>Jenis Aktivitas</th>
      <th>Waktu Mulai</th><th>Waktu Selesai</th><th>Durasi (jam)</th>
      <th>Keterangan</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="summary" style="margin-top:12px">
  <h3>Rangkuman Hari Ini</h3>
  <div style="margin-bottom:6px">
    Total Jam Kerja:
    <div class="progress-container"><div id="progressWork" class="progress-bar progress-work" style="width:0%">Belum ada kerja</div></div>
  </div>
  <div style="margin-bottom:6px">
    Aktivitas lain:
    <div class="progress-container"><div id="progressOther" class="progress-bar progress-other" style="width:0%">Belum ada aktivitas</div></div>
  </div>
  <div>
    Jam tidur:
    <div class="progress-container"><div id="progressSleep" class="progress-bar progress-sleep" style="width:0%">Belum tidur</div></div>
  </div>
</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ========== CONFIG FIREBASE (ganti jika perlu) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyCHnFBBhKUg9I0f84ai8_X7kcuQjqgSK5w",
  authDomain: "loginaksi.firebaseapp.com",
  databaseURL: "https://loginaksi-default-rtdb.firebaseio.com",
  projectId: "loginaksi",
  storageBucket: "loginaksi.firebasestorage.app",
  messagingSenderId: "720249983474",
  appId: "1:720249983474:web:169e0d8aa713cd2b699b6b",
  measurementId: "G-3P37QDYG60"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ========== UTILITY / DATA ========== */
const days = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu','Minggu'];
const activityTypes = ['Mandi','Santai','Telponan','Berangkat Kerja','Kerja','Pulang Kerja','Gym','Playgame','Tidur','Doa'];
const times = [];
for(let h=0; h<24; h++){
  for(let m=0;m<60;m+=5){
    times.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
  }
}
let allData = []; // { row, rowData }

/* ========== FUNGSI KETERANGAN ======== */
function getProgressText(type){
  if(!type) return "Aktivitas tidak diketahui";
  const t = String(type).toLowerCase().trim();
  if(t.includes('kerja')) return "ğ™ƒğ™šğ™§ğ™ ğ™ğ™šğ™™ğ™–ğ™£ğ™œ ğ˜½ğ™šğ™ ğ™šğ™§ğ™Ÿğ™–";
  if(t.includes('tidur')) return "ğ™ƒğ™šğ™§ğ™ ğ™ğ™šğ™™ğ™–ğ™£ğ™œ ğ™ğ™ğ™™ğ™ªğ™§";
  // other keywords
  const others = ['mandi','santai','telpon','berangkat','pulang','gym','play','doa'];
  for(const o of others) if(t.includes(o)) return "ğ™ƒğ™šğ™§ğ™ ğ™ğ™šğ™™ğ™–ğ™£ğ™œ ğ™ˆğ™šğ™¡ğ™–ğ™ ğ™ªğ™ ğ™–ğ™£ ğ˜¼ğ™ ğ™©ğ™ğ™«ğ™ğ™©ğ™–ğ™¨";
  return "ğ™ƒğ™šğ™§ğ™ ğ™ğ™šğ™™ğ™–ğ™£ğ™œ ğ˜½ğ™ªğ™¡ğ™–ğ™£ğ™œ"; // default
}

/* ========== ADD ROW ========== */
function addRow(data = {}){
  const tbody = document.querySelector('#activityTable tbody');
  const row = tbody.insertRow();
  const index = tbody.rows.length;
  row.innerHTML = `
    <td>${index}</td>
    <td>
      <select class="hari">${days.map(d=>`<option value="${d}">${d}</option>`).join('')}</select>
    </td>
    <td><input type="date" class="tanggal" value="${data.tanggal||''}"></td>
    <td>
      <select class="jenis">${activityTypes.map(a=>`<option value="${a}">${a}</option>`).join('')}</select>
    </td>
    <td>
      <select class="mulai">${times.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
    </td>
    <td>
      <select class="selesai">${times.map(t=>`<option value="${t}">${t}</option>`).join('')}</select>
    </td>
    <td class="duration">0</td>
    <td class="keterangan"><div class="progress-container"><div class="progress-bar progress-activity" style="width:100%">Belum dihitung</div></div></td>
    <td><button class="hapus">Hapus</button></td>
  `;

  // set default selected values from data if provided
  if(data.hari) row.querySelector('.hari').value = data.hari;
  if(data.jenis) row.querySelector('.jenis').value = data.jenis;
  if(data.mulai) row.querySelector('.mulai').value = data.mulai;
  if(data.selesai) row.querySelector('.selesai').value = data.selesai;

  // add event listeners
  const selHari = row.querySelector('.hari');
  const inpTanggal = row.querySelector('.tanggal');
  const selJenis = row.querySelector('.jenis');
  const selMulai = row.querySelector('.mulai');
  const selSelesai = row.querySelector('.selesai');
  const btnHapus = row.querySelector('.hapus');

  selHari.addEventListener('change', ()=> { updateRowColor(selHari); saveRowData(row); });
  inpTanggal.addEventListener('change', ()=> saveRowData(row));
  selJenis.addEventListener('change', ()=> { updateDuration(selJenis); saveRowData(row); });
  selMulai.addEventListener('change', ()=> { updateDuration(selMulai); saveRowData(row); });
  selSelesai.addEventListener('change', ()=> { updateDuration(selSelesai); saveRowData(row); });
  btnHapus.addEventListener('click', ()=> removeRow(btnHapus));

  // store in allData
  allData.push({ row, rowData: Object.assign({}, data) });

  // initialize visuals
  updateRowColor(selHari);
  updateDuration(selJenis); // calculates duration and keterangan
}

/* ========== UPDATE ROW COLOR (only day cell) ========== */
function updateRowColor(select){
  const cell = select.parentElement;
  // example mapping, you can customize
  const map = {
    'Senin':'#fff0f0','Selasa':'#f0fff0','Rabu':'#f0f8ff','Kamis':'#fff6e6','Jumat':'#f9f0ff','Sabtu':'#fff0e6','Minggu':'#f0ffff'
  };
  cell.style.background = map[select.value] || '#ffffff';
}

/* ========== SAVE one row into allData.rowData = keep current inputs ========== */
function saveRowData(row){
  const index = allData.findIndex(e=>e.row===row);
  if(index === -1) return;
  allData[index].rowData = {
    hari: row.querySelector('.hari').value,
    tanggal: row.querySelector('.tanggal').value,
    jenis: row.querySelector('.jenis').value,
    mulai: row.querySelector('.mulai').value,
    selesai: row.querySelector('.selesai').value,
    durasi: parseFloat(row.querySelector('.duration').innerText) || 0
  };
  // console.log('saved rowData', allData[index].rowData);
}

/* ========== REMOVE ROW ========== */
function removeRow(btn){
  const row = btn.closest('tr');
  const idx = allData.findIndex(e=>e.row===row);
  if(idx>-1) allData.splice(idx,1);
  row.remove();
  // refresh numbers
  document.querySelectorAll('#activityTable tbody tr').forEach((r,i)=> r.cells[0].innerText = i+1);
}

/* ========== UPDATE DURATION & KETERANGAN ========== */
function updateDuration(elementInsideRow){
  const row = elementInsideRow.closest('tr');
  const mulai = row.querySelector('.mulai').value || '00:00';
  const selesai = row.querySelector('.selesai').value || '00:00';
  const s = mulai.split(':').map(Number);
  const e = selesai.split(':').map(Number);
  let minutes = (e[0]*60 + e[1]) - (s[0]*60 + s[1]);
  if(minutes < 0) minutes += 24*60;
  const hours = (minutes/60);
  row.querySelector('.duration').innerText = (Math.round(hours*100)/100).toFixed(2);

  // warna sel waktu (only the cell)
  row.querySelector('td:nth-child(5)').style.background = (s[0] < 18) ? '#d4edda' : '#f8d7da';
  row.querySelector('td:nth-child(6)').style.background = (e[0] < 18) ? '#d4edda' : '#f8d7da';

  // update keterangan text
  const jenis = row.querySelector('.jenis').value;
  const progressBar = row.querySelector('.progress-bar');
  progressBar.innerText = getProgressText(jenis);
  // keep width fixed to show text
  progressBar.style.width = '100%';

  // save snapshot into allData
  saveRowData(row);
}

/* ========== FILTER BY DATE ========== */
function filterByDate(){
  const filter = document.getElementById('filterDate').value;
  document.querySelectorAll('#activityTable tbody tr').forEach(row=>{
    const val = row.querySelector('.tanggal').value;
    row.style.display = (!filter || filter === val) ? '' : 'none';
  });
  showSummary(filter);
}

/* ========== SHOW SUMMARY ========== */
function showSummary(filterDate=null){
  let totalWork=0, other=0, sleep=0;
  document.querySelectorAll('#activityTable tbody tr').forEach(row=>{
    if(row.style.display === 'none') return;
    if(filterDate && row.querySelector('.tanggal').value !== filterDate) return;
    const jenis = row.querySelector('.jenis').value.toLowerCase();
    const dur = parseFloat(row.querySelector('.duration').innerText) || 0;
    if(jenis.includes('kerja')) totalWork += dur;
    else if(jenis.includes('tidur')) sleep += dur;
    else other += dur;
  });
  const total = totalWork + other + sleep || 1;
  const workPerc = ((totalWork/total)*100).toFixed(1);
  const otherPerc = ((other/total)*100).toFixed(1);
  const sleepPerc = ((sleep/total)*100).toFixed(1);
  document.getElementById('progressWork').innerText = totalWork>0 ? 'Kerja: '+workPerc+'%' : 'Belum ada kerja';
  document.getElementById('progressOther').innerText = other>0 ? 'Aktivitas lain: '+otherPerc+'%' : 'Belum ada aktivitas';
  document.getElementById('progressSleep').innerText = sleep>0 ? 'Tidur: '+sleepPerc+'%' : 'Belum tidur';
  document.getElementById('progressWork').style.width = workPerc + '%';
  document.getElementById('progressOther').style.width = otherPerc + '%';
  document.getElementById('progressSleep').style.width = sleepPerc + '%';
}

/* ========== SAVE TO FIREBASE (push each row) ========== */
function saveToFirebase(){
  const user = auth.currentUser;
  if(!user){ alert('Silakan login dulu!'); return; }
  // push each current allData row
  // (we assume each allData element has up-to-date rowData)
  let pushed = 0;
  allData.forEach(item=>{
    // ensure rowData saved
    saveRowData(item.row);
    const r = item.rowData;
    if(!r || !r.tanggal) {
      // skip rows with no date (optional)
      // console.log('skip row, no data', r);
      // but we can still push if needed
    }
    const payload = {
      uid: user.uid,
      hari: r.hari || '',
      tanggal: r.tanggal || '',
      jenis: r.jenis || '',
      mulai: r.mulai || '',
      selesai: r.selesai || '',
      durasi: r.durasi || 0,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    db.ref('jadwal').push(payload).then(()=> {
      // optional success per push
    }).catch(err=>{
      console.error('push error', err);
      alert('Error menyimpan: ' + err.message);
    });
    pushed++;
  });
  alert('Mengirim ' + pushed + ' baris ke Firebase (cek database).');
}

/* ========== LOAD FROM FIREBASE ========== */
function loadFromFirebase(){
  db.ref('jadwal').on('value', snapshot=>{
    const val = snapshot.val();
    // clear table
    const tbody = document.querySelector('#activityTable tbody');
    tbody.innerHTML = '';
    allData = [];
    if(!val) { addRow(); return; }
    // val is object keyed by push id
    Object.values(val).forEach(item=>{
      addRow({
        hari: item.hari,
        tanggal: item.tanggal,
        jenis: item.jenis,
        mulai: item.mulai,
        selesai: item.selesai,
        durasi: item.durasi
      });
    });
    showSummary();
  }, err => {
    console.error('loadFromFirebase error', err);
  });
}

/* ========== INITIALIZATION ========== */
auth.onAuthStateChanged(user=>{
  console.log('auth state changed', user && user.uid);
  // do not auto-redirect here; assume login.html handles redirect
});
loadFromFirebase();

</script>
</body>
</html>
